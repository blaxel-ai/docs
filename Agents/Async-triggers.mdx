# ‚ö° Async Triggers

Async triggers let your agent return immediately while the task continues running in the background.  
This is useful for long-running operations, workflows, or when your endpoint must respond quickly.

---

## üöÄ How Async Triggers Work

### 1. Enable an async trigger  
When you enable an async trigger, your agent can now handle requests asynchronously.  

To use it:

- Call your agent URL and append `?async=true` to the query string:

```
POST https://run.blaxel.ai/myworkspace/agents/myagent?async=true
```

- (Optional) Provide a **callback URL** if you want to receive the result when the background job completes.
- If you set a callback URL, a **callback secret** is generated (shown once) and used to sign all webhook requests.

**Notes:**

- If no callback URL is provided, no secret is created and no webhook will be sent.
- The async URL is **simply your original agent URL** with `?async=true`; there is no separate URL to manage.

---

### 2. Call your agent

When you call the agent with `?async=true`, it immediately returns:

```json
{ "success": true }
```

Meanwhile, the full request is processed asynchronously in the background.

---

## üîÑ Optional: Callback Webhooks

If you configured a **callback URL**, the async system will send a webhook when the background job completes.

### Callback payload example

```json
{
  "status_code": 200,
  "response_body": "{\"result\":\"ok\"}",
  "response_length": 123,
  "timestamp": 1735891200
}
```

### Callback signing

When a callback URL is set:

- A **callback secret** is generated (shown once)
- Each webhook includes the following headers:

```
X-Blaxel-Signature: sha256=<hex>
X-Blaxel-Timestamp: <unix timestamp>
```

Use the SDK to verify signatures.  

If no callback URL is set:

- No secret is generated  
- No webhook is sent  
- Async behavior is fire-and-forget

---

## üß™ TypeScript Example (With Callback)

```ts
import express from "express";
import { verifyWebhookFromRequest } from "@blaxel/core";

const app = express();
const CALLBACK_SECRET = process.env.CALLBACK_SECRET!;

// Preserve raw body for signature verification
app.use(express.text({ type: "application/json" }));

app.post("/callback", (req, res) => {
  if (!verifyWebhookFromRequest(req, CALLBACK_SECRET)) {
    return res.status(401).json({ error: "Invalid signature" });
  }

  const data = JSON.parse(req.body);
  console.log("Async job completed:", data);

  res.json({ received: true });
});
```

### Trigger async execution:

```ts
await fetch(
  "https://run.blaxel.ai/myworkspace/agents/myagent?async=true",
  {
    method: "POST",
    body: JSON.stringify({ input: "Hello" })
  }
);
```

---

## üêç Python Example (With Callback)

```python
from flask import Flask, request, jsonify
from blaxel.core import verify_webhook_from_request
import os, json

app = Flask(__name__)
CALLBACK_SECRET = os.environ["CALLBACK_SECRET"]

class ReqWrapper:
    def __init__(self, req):
        self.body = req.get_data()
        self.headers = {k.lower(): v for k, v in req.headers.items()}

@app.post("/callback")
def callback():
    if not verify_webhook_from_request(ReqWrapper(request), CALLBACK_SECRET):
        return jsonify({"error": "invalid signature"}), 401

    data = request.json
    print("Async job finished:", data)
    return jsonify({"received": True})
```

### Trigger async execution:

```python
import requests

requests.post(
    "https://run.blaxel.ai/myworkspace/agents/myagent?async=true",
    json={"input": "Hello"}
)
```

---

## üñ•Ô∏è Managing Async Triggers in the UI

Async triggers can also be managed directly through the Blaxel UI.

### 1. Trigger List

All existing triggers are listed in the **Triggers** page.  
This is the main entry point to view, edit, or remove triggers.

![Triggers List](triggers.png)

---

### 2. Add a New Trigger

Click **Add Trigger** to create a new async trigger.  
You can optionally configure a **callback URL** here if you want to receive the result when the job completes.

![Trigger Configuration](configuration.png)

> ‚ö†Ô∏è If no callback URL is set, the trigger will work in fire-and-forget mode.

---

### 3. Callback Secret

After creating a trigger with a callback URL, a **callback secret** is displayed.  
This secret is used to verify the authenticity of incoming webhooks.  

![Callback Secret](secret.png)

> üîê Keep this secret safe. It is only shown once.

**Note:** If you do not set a callback URL, no secret is generated and no webhooks will be sent. The trigger will still execute asynchronously when called with `?async=true`.

---

## ‚öôÔ∏è Configuring Async Triggers via `blaxel.toml`

You can also configure async triggers directly in your `blaxel.toml` file.  

### Example configuration

```toml
type = "agent"
name = "async-agent"

[[triggers]]
  id = "async"
  type = "http-async"
[triggers.configuration]
  callbackUrl = "https://0404cc710a19.myapp.com/webhook"
```

### Explanation

- `type = "agent"` ‚Äì Defines this as an agent  
- `[[triggers]]` ‚Äì Each trigger configuration block  
- `id = "async"` ‚Äì Unique identifier for the trigger  
- `type = "http-async"` ‚Äì Marks the trigger as asynchronous  
- `[triggers.configuration]` ‚Äì Optional configuration section  
  - `callbackUrl` ‚Äì Optional. If provided, a **callback secret** will be generated and used to sign webhook requests.

**Notes:**

- If no `callbackUrl` is specified, the trigger still works asynchronously, but no webhook will be sent.  
- The agent URL to call asynchronously is **your agent URL with `?async=true`**, same as in the UI or SDK examples.  
- Secrets are only generated if a callback URL is set. Keep them secure.  
- This approach allows you to version-control triggers and manage them alongside your agent code.

---

## üìù Summary

| Feature | Behavior |
|--------|----------|
| **Async URL** | Simply your agent URL with `?async=true` |
| **Callback URL** | Optional; user must provide it if desired |
| **Callback secret** | Generated only if a callback URL is set |
| **Webhook result** | Sent only if callback URL exists |
| **Default behavior** | Fire-and-forget async execution |

---

This setup allows you to convert synchronous agent requests into asynchronous workflows **without changing your agent code**, while optionally receiving signed callbacks when the job completes.